<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<packaging>pom</packaging>
	<parent>
		<artifactId>base-mantychore</artifactId>
		<groupId>net.i2cat.mantychore</groupId>
		<version>1.0.0-SNAPSHOT</version>
	</parent>

	<name>Mantychore platform</name>
	<artifactId>platform</artifactId>
	<!--  properties to use fuse  -->
	<properties>
		<target-platform.path>target/mantychore</target-platform.path>
		<opennaas.path>opennaas-${project.version}</opennaas.path>
	</properties>

	<!--
  | imported (non-local) bundles are listed here as dependencies | and
  will be deployed by pax:provision unless they are marked | with
  <optional>true</optional>
 -->
	<build>
		<resources>
			<resource>
				<directory>${project.basedir}/src/main/filtered-resources</directory>
				<filtering>true</filtering>
				<includes>
					<include>**/*</include>
				</includes>
			</resource>
		</resources>
		<plugins>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-dependency-plugin</artifactId>
				<executions>
					<execution>
						<id>unpack-opennaas</id>
						<!-- Run this before any other goal in package phase -->
						<phase>prepare-package</phase>
						<goals>
							<goal>unpack</goal>
						</goals>
						<configuration>
							<artifactItems>
								<artifactItem>
									<groupId>org.opennaas</groupId>
									<artifactId>assembly</artifactId>
									<version>${opennaas.version}</version>
								</artifactItem>
							</artifactItems>
							<outputDirectory>${target-platform.path}</outputDirectory>
							<overWriteIfNewer>true</overWriteIfNewer>
							<excludes>**\/bin\/opennaas,**\/bin\/opennaas.bat</excludes>
						</configuration>
					</execution>
					<execution>
						<id>get-mantychore-feature</id>
						<phase>package</phase>
						<goals>
							<goal>copy</goal>
						</goals>
						<configuration>
							<artifactItems>
								<artifactItem>
									<artifactId>mantychore</artifactId>
									<groupId>net.i2cat.mantychore</groupId>
									<version>${project.version}</version>
									<!-- TODO: use variable project.version -->
									<type>xml</type>
									<classifier>features</classifier>
									<outputDirectory>${target-platform.path}/${opennaas.path}/system/net/i2cat/mantychore/mantychore/${project.version}/</outputDirectory>
									<overWrite>true</overWrite>
									<destFileName>mantychore-${project.version}-features.xml</destFileName>
								</artifactItem>
							</artifactItems>
						</configuration>
					</execution>
				</executions>
			</plugin>
		<plugin>
				<groupId>org.apache.karaf.tooling</groupId>
				<artifactId>features-maven-plugin</artifactId>
				<executions>
					<execution>
						<id>add-features-to-repo</id>
						<phase>package</phase>
						<goals>
							<goal>add-features-to-repo</goal>
						</goals>
						<configuration>
							<karafVersion>${karaf.version}</karafVersion>
							<descriptors>
								<descriptor>mvn:org.apache.karaf.assemblies.features/standard/${karaf.version}/xml/features</descriptor>
								<descriptor>mvn:org.apache.servicemix.nmr/apache-servicemix-nmr/${nmr.version}/xml/features</descriptor>
								<descriptor>mvn:org.apache.camel.karaf/apache-camel/${camel.version}/xml/features</descriptor>
								<descriptor>mvn:org.opennaas/opennaas-core-features/${opennaas.version}/xml/features</descriptor>
								<descriptor>mvn:net.i2cat.mantychore/mantychore/${project.version}/xml/features</descriptor>
							</descriptors>
							<addTransitiveFeatures>true</addTransitiveFeatures>
							<features>
								<feature>opennaas</feature>
								<feature>nexus-tests-helper</feature>
								<feature>nexus-testprofile</feature>
							</features>
							<repository>${target-platform.path}/${opennaas.path}/system</repository>
						</configuration>
					</execution>
				</executions>
			</plugin>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-resources-plugin</artifactId>
				<executions>
					<!-- process the resources to resolve the version variables -->
					<execution>
						<id>filter-resources</id>
						<goals>
							<goal>resources</goal>
						</goals>
						<phase>process-resources</phase>
						<configuration>
							<!-- specify UTF-8, ISO-8859-1 or any other file encoding -->
							<encoding>UTF-8</encoding>
						</configuration>
					</execution>
					<execution>
						<id>install-mantychore-configs</id>
						<phase>package</phase>
						<goals>
							<goal>copy-resources</goal>
						</goals>
						<configuration>
							<outputDirectory>${target-platform.path}/${opennaas.path}</outputDirectory>
							<!--
      <resources>
		  <resource>
		    <directory>src/main/java</directory>
		    <includes>
		      <include>**/*.xml</include>
		    </includes>
		  </resource>
	  </resources>
      -->
							<overwrite>true</overwrite>
							<resources>
								<resource>
									<directory>target/classes</directory>
								</resource>
							</resources>
							<encoding>UTF-8</encoding>
						</configuration>
					</execution>
					<!--  Try to copy the files under service mix into the root iaas dir and delete the service mix dir with the
     maven clean plugin... -->
				</executions>
			</plugin>
		</plugins>
	</build>
</project>

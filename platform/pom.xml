<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<packaging>pom</packaging>
	<parent>
		<artifactId>opennaas</artifactId>
		<groupId>org.opennaas</groupId>
		<version>1.0.0-SNAPSHOT</version>
	</parent>
	<name>OpenNaaS platform</name>
	<artifactId>platform</artifactId>
	<!--  properties to use fuse  -->
	<properties>
		<target-platform.path>target/opennaas</target-platform.path>
		<servicemix.path>apache-servicemix-${servicemix.version}</servicemix.path>
	</properties>
	<dependencies>
		<dependency>
			<groupId>org.opennaas</groupId>
			<artifactId>karafbranding-opennaas</artifactId>
		</dependency>
	</dependencies>
	<!--
  | imported (non-local) bundles are listed here as dependencies | and
  will be deployed by pax:provision unless they are marked | with
  <optional>true</optional>
 -->
	<build>
		<resources>
			<resource>
				<directory>${pom.basedir}/src/main/filtered-resources</directory>
				<filtering>true</filtering>
				<includes>
					<include>**/*</include>
				</includes>
			</resource>
		</resources>
		<plugins>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-dependency-plugin</artifactId>
				<executions>
					<execution>
						<id>unpack-apache-servicemix</id>
						<phase>package</phase>
						<goals>
							<goal>unpack</goal>
						</goals>
						<configuration>
							<artifactItems>
								<artifactItem>
									<groupId>org.apache.servicemix</groupId>
									<artifactId>apache-servicemix</artifactId>
									<version>${servicemix.version}</version>
								</artifactItem>
							</artifactItems>
							<outputDirectory>${target-platform.path}</outputDirectory>
							<overWriteIfNewer>true</overWriteIfNewer>
							<excludes>**\/bin\/servicemix,**\/bin\/servicemix.bat,**\/examples\/**</excludes>
							<!--<chmod file="${target-platform.path}/${servicemix.path}/bin/*" perm="ugo+rx" />-->
						</configuration>
					</execution>
					<execution>
						<id>copy-karafbranding</id>
						<phase>package</phase>
						<goals>
							<goal>copy</goal>
						</goals>
						<configuration>
							<artifactItems>
								<artifactItem>
									<groupId>org.opennaas</groupId>
									<artifactId>karafbranding-opennaas</artifactId>
								</artifactItem>
							</artifactItems>
							<outputDirectory>${target-platform.path}/${servicemix.path}/lib</outputDirectory>
							<overWriteIfNewer>true</overWriteIfNewer>
						</configuration>
					</execution>
					<execution>
						<id>get-opennaas-feature</id>
						<phase>package</phase>
						<goals>
							<goal>copy</goal>
						</goals>
						<configuration>
							<artifactItems>
								<artifactItem>
									<artifactId>opennaas-core-features</artifactId>
									<groupId>org.opennaas</groupId>
									<version>${opennaas.version}</version>
									<type>xml</type>
									<classifier>features</classifier>
									<outputDirectory>${target-platform.path}/${servicemix.path}/system/org/opennaas/opennaas-core-features/${opennaas.version}/</outputDirectory>
									<overWrite>true</overWrite>
									<destFileName>opennaas-core-features-${opennaas.version}-features.xml</destFileName>
								</artifactItem>
							</artifactItems>
						</configuration>
					</execution>
				</executions>
			</plugin>
			<plugin>
				<groupId>org.apache.karaf.tooling</groupId>
				<artifactId>features-maven-plugin</artifactId>
				<executions>
					<execution>
						<id>add-features-to-repo</id>
						<phase>generate-resources</phase>
						<goals>
							<goal>add-features-to-repo</goal>
						</goals>
						<configuration>
							<karafVersion>${karaf.version}</karafVersion>
							<descriptors>
								<descriptor>mvn:org.apache.servicemix/apache-servicemix/${servicemix.version}/xml/features</descriptor>
								<descriptor>mvn:org.apache.servicemix.nmr/apache-servicemix-nmr/${nmr.version}/xml/features</descriptor>
								<descriptor>mvn:org.apache.activemq/activemq-karaf/${activemq.version}/xml/features</descriptor>
								<descriptor>mvn:org.opennaas/opennaas-core-features/${project.version}/xml/features</descriptor>
							</descriptors>
							<!-- Only add the features we specify
							     explicitly.  Remaining features are
							     included by copying servicemix above.
							     -->
							<addTransitiveFeatures>false</addTransitiveFeatures>
							<features>
								<feature>opennaas-core-deps</feature>
								<feature>opennaas-core</feature>
							</features>
							<repository>${target-platform.path}/${servicemix.path}/system</repository>
						</configuration>
					</execution>
				</executions>
			</plugin>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-resources-plugin</artifactId>
				<executions>
					<!-- process the resources to resolve the version variables -->
					<execution>
						<id>filter-resources</id>
						<goals>
							<goal>resources</goal>
						</goals>
						<phase>process-resources</phase>
						<configuration>
							<!-- specify UTF-8, ISO-8859-1 or any other file encoding -->
							<encoding>UTF-8</encoding>
						</configuration>
					</execution>
					<execution>
						<id>install-opennaas-configs</id>
						<phase>package</phase>
						<goals>
							<goal>copy-resources</goal>
						</goals>
						<configuration>
							<outputDirectory>${target-platform.path}/${servicemix.path}</outputDirectory>
							<!--
      <resources>
		  <resource>
		    <directory>src/main/java</directory>
		    <includes>
		      <include>**/*.xml</include>
		    </includes>
		  </resource>
	  </resources>
      -->
							<overwrite>true</overwrite>
							<outputDirectory>${target-platform.path}/${servicemix.path}</outputDirectory>
							<resources>
								<resource>
									<directory>target/classes</directory>
								</resource>
							</resources>
						</configuration>
					</execution>
					<!--  Try to copy the files under service mix into the root iaas dir and delete the service mix dir with the
     maven clean plugin... -->
				</executions>
			</plugin>
		</plugins>
	</build>
</project>
